name: Build Odin4

on:
  workflow_dispatch:
    inputs:
      suffix:
        description: 'Optional suffix appended to the filename (e.g. -rc1, -beta). Leave empty for none.'
        required: false
        default: ''
      bundle:
        description: 'Also create a single zip containing both architectures'
        required: false
        type: boolean
        default: true

permissions:
  contents: write

jobs:
  build:
    name: Build for Linux (${{ matrix.arch }})
    runs-on: ${{ matrix.runner }}

    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: x86_64
            runner: ubuntu-22.04
          - arch: arm64
            runner: ubuntu-22.04-arm

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            cmake \
            ninja-build \
            zip \
            make \
            pkg-config \
            g++ \
            git \
            libusb-1.0-0-dev \
            libcrypto++-dev

      - name: Ensure Crypto++ static library is available
        shell: bash
        run: |
          set -euo pipefail
          A_PATH="$(find /usr -type f -name 'libcryptopp.a' 2>/dev/null | head -n 1 || true)"
          if [ -z "$A_PATH" ]; then
            echo "Building Crypto++ static..."
            rm -rf /tmp/cryptopp
            git clone --depth 1 --branch CRYPTOPP_8_9_0 https://github.com/weidai11/cryptopp.git /tmp/cryptopp
            cd /tmp/cryptopp
            make -j"$(nproc)"
            sudo make install PREFIX=/usr/local
            sudo ldconfig || true
          fi

      - name: Read version from source
        shell: bash
        run: |
          set -euo pipefail
          SRC_FILE="src/main.cpp"

          VERSION="$(grep -E '^[[:space:]]*#define[[:space:]]+ODIN4_VERSION[[:space:]]+"' "$SRC_FILE" \
            | sed -E 's/.*ODIN4_VERSION[[:space:]]+"([^"]+)".*/\1/' \
            | head -n 1)"

          if [ -z "$VERSION" ]; then
            echo "ERROR: Could not parse ODIN4_VERSION" >&2
            exit 1
          fi

          EVENT="${{ github.event_name }}"

          if [ "$EVENT" = "push" ]; then
            DATE="$(date -u +%Y%m%d)"
            SHA="$(git rev-parse --short=7 HEAD)"
            SUFFIX="-nightly-${DATE}-${SHA}"
          else
            SUFFIX="${{ inputs.suffix }}"
            if [ -n "$SUFFIX" ] && [[ "$SUFFIX" != -* ]]; then
              SUFFIX="-$SUFFIX"
            fi
          fi

          echo "ODIN4_VERSION=$VERSION" >> "$GITHUB_ENV"
          echo "ODIN4_SUFFIX=$SUFFIX" >> "$GITHUB_ENV"
          echo "ODIN4_OUTNAME=odin4_${{ matrix.arch }}_${VERSION}${SUFFIX}" >> "$GITHUB_ENV"

      - name: Clean build dir
        run: rm -rf build

      - name: Configure CMake
        run: |
          cmake -S . -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_PREFIX_PATH="/usr/local"

      - name: Build
        run: |
          cmake --build build --parallel $(nproc)

      - name: Verify runtime dependencies
        shell: bash
        run: |
          set -euo pipefail
          BIN="build/odin4"
          if [ ! -f "$BIN" ]; then
            echo "ERROR: build/odin4 not found." >&2
            exit 1
          fi
          if ldd "$BIN" | grep -qiE 'libcrypto\+\+\.so'; then
            echo "ERROR: Binary still depends on libcrypto++.so." >&2
            exit 1
          fi

      - name: Package artifact
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p dist
          cp build/odin4 "dist/${ODIN4_OUTNAME}"
          strip "dist/${ODIN4_OUTNAME}" || true
          cd dist
          ZIP_NAME="odin4-linux-${{ matrix.arch }}-${ODIN4_VERSION}${ODIN4_SUFFIX}.zip"
          zip "../${ZIP_NAME}" "${ODIN4_OUTNAME}"
          echo "ZIP_NAME=${ZIP_NAME}" >> "$GITHUB_ENV"

      - name: Upload artifact
        uses: actions/upload-artifact@v6
        with:
          name: odin4-linux-${{ matrix.arch }}-${{ env.ODIN4_VERSION }}${{ env.ODIN4_SUFFIX }}
          path: ${{ env.ZIP_NAME }}

  bundle:
    name: Bundle (single zip with both arch)
    runs-on: ubuntu-22.04
    needs: build
    if: ${{ github.event_name == 'push' || inputs.bundle }}

    steps:
      - name: Download all build artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create unified bundle zip
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p bundle
          find artifacts -type f -name "*.zip" -exec cp {} bundle/ \;
          SAMPLE="$(ls -1 bundle/*.zip | head -n 1 || true)"
          if [ -z "$SAMPLE" ]; then
            echo "ERROR: No zip artifacts found." >&2
            exit 1
          fi
          BASE="$(basename "$SAMPLE")"
          VERSUFFIX="$(echo "$BASE" | sed -E 's/^odin4-linux-[^-]+-(.+)\.zip$/\1/')"
          OUT="odin4-linux-all-${VERSUFFIX}.zip"
          (cd bundle && zip "../${OUT}" ./*.zip)
          echo "OUT=${OUT}" >> "$GITHUB_ENV"

      - name: Upload bundle artifact
        uses: actions/upload-artifact@v6
        with:
          name: odin4-linux-all
          path: ${{ env.OUT }}

  publish_nightly:
    name: Publish Nightly Pre-Release
    runs-on: ubuntu-22.04
    needs: [build, bundle]
    if: ${{ github.event_name == 'workflow_dispatch' }}

    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Collect zips
        run: |
          set -euo pipefail
          mkdir -p dist
          find artifacts -type f -name "*.zip" -exec cp {} dist/ \;
          if ! ls dist/*.zip 1> /dev/null 2>&1; then
            echo "No zip files found."
            exit 1
          fi

      - name: Publish or update Nightly pre-release
        uses: ncipollo/release-action@v1
        with:
          tag: nightly
          name: Nightly (pre-release)
          prerelease: true
          allowUpdates: true
          replacesArtifacts: true
          artifacts: "dist/*.zip"
          body: |
            Automated nightly build from latest main.

            Commit: ${{ github.sha }}
            Run: ${{ github.run_id }}