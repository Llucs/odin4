name: Build Odin4

on:
  workflow_dispatch:
    inputs:
      suffix:
        description: 'Optional suffix appended to the filename (e.g. -rc1, -beta). Leave empty for none.'
        required: false
        default: ''
      bundle:
        description: 'Also create a single zip containing both architectures'
        required: false
        type: boolean
        default: true

jobs:
  build:
    name: Build for Linux (${{ matrix.arch }})
    runs-on: ${{ matrix.runner }}

    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: x86_64
            runner: ubuntu-22.04
          - arch: arm64
            runner: ubuntu-22.04-arm

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            cmake \
            ninja-build \
            zip \
            make \
            pkg-config \
            g++ \
            git \
            libusb-1.0-0-dev \
            libcrypto++-dev

      - name: Ensure Crypto++ static library is available
        shell: bash
        run: |
          set -euo pipefail

          echo "Checking for libcryptopp.a..."
          A_PATH="$(ls -1 /usr/lib*/**/libcryptopp.a 2>/dev/null | head -n 1 || true)"
          if [ -n "$A_PATH" ]; then
            echo "Found static Crypto++: $A_PATH"
            exit 0
          fi

          echo "libcryptopp.a not found via apt packages. Building Crypto++ static from source..."
          rm -rf /tmp/cryptopp
          git clone --depth 1 --branch CRYPTOPP_8_9_0 https://github.com/weidai11/cryptopp.git /tmp/cryptopp
          cd /tmp/cryptopp

          make -j"$(nproc)"
          sudo make install PREFIX=/usr/local

          sudo ldconfig || true

          A_PATH2="$(ls -1 /usr/local/lib*/libcryptopp.a 2>/dev/null | head -n 1 || true)"
          if [ -z "$A_PATH2" ]; then
            echo "ERROR: Crypto++ static library build/install failed (libcryptopp.a still not found)." >&2
            exit 1
          fi

          echo "Installed static Crypto++: $A_PATH2"

      - name: Read version from source
        shell: bash
        run: |
          set -euo pipefail

          SRC_FILE="src/main.cpp"

          VERSION="$(grep -E '^[[:space:]]*#define[[:space:]]+ODIN4_VERSION[[:space:]]+"' "$SRC_FILE" \
            | sed -E 's/.*ODIN4_VERSION[[:space:]]+"([^"]+)".*/\1/' \
            | head -n 1)"

          if [ -z "$VERSION" ]; then
            echo "ERROR: Could not parse ODIN4_VERSION from $SRC_FILE" >&2
            exit 1
          fi

          SUFFIX="${{ inputs.suffix }}"
          if [ -n "$SUFFIX" ] && [[ "$SUFFIX" != -* ]]; then
            SUFFIX="-$SUFFIX"
          fi

          echo "ODIN4_VERSION=$VERSION" >> "$GITHUB_ENV"
          echo "ODIN4_SUFFIX=$SUFFIX" >> "$GITHUB_ENV"
          echo "ODIN4_OUTNAME=odin4_${{ matrix.arch }}_${VERSION}${SUFFIX}" >> "$GITHUB_ENV"

      - name: Configure CMake
        run: |
          cmake -S . -B build -G Ninja -DCMAKE_BUILD_TYPE=Release

      - name: Build
        run: |
          cmake --build build --parallel $(nproc)

      - name: Verify runtime dependencies (must not depend on libcrypto++.so)
        shell: bash
        run: |
          set -euo pipefail

          BIN="build/odin4"
          if [ ! -f "$BIN" ]; then
            echo "ERROR: build/odin4 not found." >&2
            exit 1
          fi

          echo "ldd check:"
          ldd "$BIN" || true

          if ldd "$BIN" | grep -qiE 'libcrypto\+\+\.so'; then
            echo "ERROR: Binary still depends on libcrypto++.so. Static link failed." >&2
            exit 1
          fi

      - name: Package artifact
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p dist

          cp build/odin4 "dist/${ODIN4_OUTNAME}"
          strip "dist/${ODIN4_OUTNAME}" || true

          cd dist
          ZIP_NAME="odin4-linux-${{ matrix.arch }}-${ODIN4_VERSION}${ODIN4_SUFFIX}.zip"
          zip "../${ZIP_NAME}" "${ODIN4_OUTNAME}"

          echo "ZIP_NAME=${ZIP_NAME}" >> "$GITHUB_ENV"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: odin4-linux-${{ matrix.arch }}-${{ env.ODIN4_VERSION }}${{ env.ODIN4_SUFFIX }}
          path: ${{ env.ZIP_NAME }}

  bundle:
    name: Bundle (single zip with both arch)
    runs-on: ubuntu-22.04
    needs: build
    if: ${{ inputs.bundle }}

    steps:
      - name: Download all build artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create unified bundle zip
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p bundle
          find artifacts -type f -name "*.zip" -exec cp {} bundle/ \;

          SAMPLE="$(ls -1 bundle/*.zip | head -n 1 || true)"
          if [ -z "$SAMPLE" ]; then
            echo "ERROR: No zip artifacts found to bundle." >&2
            exit 1
          fi

          BASE="$(basename "$SAMPLE")"
          VERSUFFIX="$(echo "$BASE" | sed -E 's/^odin4-linux-[^-]+-(.+)\.zip$/\1/' || true)"
          if [ -z "$VERSUFFIX" ] || [ "$VERSUFFIX" = "$BASE" ]; then
            OUT="odin4-linux-all.zip"
          else
            OUT="odin4-linux-all-${VERSUFFIX}.zip"
          fi

          (cd bundle && zip "../${OUT}" ./*.zip)
          echo "OUT=${OUT}" >> "$GITHUB_ENV"

      - name: Upload bundle artifact
        uses: actions/upload-artifact@v4
        with:
          name: odin4-linux-all
          path: ${{ env.OUT }}