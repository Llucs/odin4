name: Build Odin4

on:
  workflow_dispatch:
    inputs:
      suffix:
        description: 'Optional suffix appended to the filename (e.g. -rc1, -beta). Leave empty for none.'
        required: false
        default: ''
      bundle:
        description: 'Also create a single zip containing both architectures'
        required: false
        type: boolean
        default: true

jobs:
  build:
    name: Build for Linux (${{ matrix.arch }})
    runs-on: ${{ matrix.runner }}

    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: x86_64
            runner: ubuntu-22.04
          - arch: arm64
            runner: ubuntu-22.04-arm

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            cmake \
            ninja-build \
            zip \
            make \
            pkg-config \
            g++ \
            libusb-1.0-0-dev \
            libcrypto++-dev

      - name: Read version from source
        shell: bash
        run: |
          # Adjust this path if ODIN4_VERSION moves
          SRC_FILE="src/main.cpp"

          VERSION="$(grep -E '^[[:space:]]*#define[[:space:]]+ODIN4_VERSION[[:space:]]+"' "$SRC_FILE" \
            | sed -E 's/.*ODIN4_VERSION[[:space:]]+"([^"]+)".*/\1/' \
            | head -n 1)"

          if [ -z "$VERSION" ]; then
            echo "ERROR: Could not parse ODIN4_VERSION from $SRC_FILE" >&2
            exit 1
          fi

          # Normalize optional suffix: allow "", "-rc1", "rc1" -> becomes "-rc1"
          SUFFIX="${{ inputs.suffix }}"
          if [ -n "$SUFFIX" ] && [[ "$SUFFIX" != -* ]]; then
            SUFFIX="-$SUFFIX"
          fi

          echo "ODIN4_VERSION=$VERSION" >> "$GITHUB_ENV"
          echo "ODIN4_SUFFIX=$SUFFIX" >> "$GITHUB_ENV"
          echo "ODIN4_OUTNAME=odin4_${{ matrix.arch }}_${VERSION}${SUFFIX}" >> "$GITHUB_ENV"

      - name: Configure CMake
        run: |
          cmake -S . -B build -G Ninja -DCMAKE_BUILD_TYPE=Release

      - name: Build
        run: |
          cmake --build build --parallel $(nproc)

      - name: Package artifact
        shell: bash
        run: |
          mkdir -p dist

          # Find produced binary
          if [ -f build/odin4 ]; then
            cp build/odin4 "dist/${ODIN4_OUTNAME}"
          else
            # fallback: find any executable that is not a shared lib
            FOUND="$(find build -type f -executable -not -name "*.so*" | head -n 1)"
            if [ -z "$FOUND" ]; then
              echo "ERROR: Could not find built executable in build/" >&2
              exit 1
            fi
            cp "$FOUND" "dist/${ODIN4_OUTNAME}"
          fi

          strip "dist/${ODIN4_OUTNAME}" || true

          cd dist
          ZIP_NAME="odin4-linux-${{ matrix.arch }}-${ODIN4_VERSION}${ODIN4_SUFFIX}.zip"
          zip "../${ZIP_NAME}" "${ODIN4_OUTNAME}"

          echo "ZIP_NAME=${ZIP_NAME}" >> "$GITHUB_ENV"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: odin4-linux-${{ matrix.arch }}-${{ env.ODIN4_VERSION }}${{ env.ODIN4_SUFFIX }}
          path: ${{ env.ZIP_NAME }}

  bundle:
    name: Bundle (single zip with both arch)
    runs-on: ubuntu-22.04
    needs: build
    if: ${{ inputs.bundle }}

    steps:
      - name: Download all build artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create unified bundle zip
        shell: bash
        run: |
          mkdir -p bundle
          # Collect all zips generated by matrix jobs
          find artifacts -type f -name "*.zip" -exec cp {} bundle/ \;

          # Create a single zip that contains those zips (simple + safe)
          # Result: odin4-linux-all-<ver><suffix>.zip with two inside
          # We'll infer version/suffix from one filename.
          SAMPLE="$(ls -1 bundle/*.zip | head -n 1)"
          if [ -z "$SAMPLE" ]; then
            echo "ERROR: No zip artifacts found to bundle." >&2
            exit 1
          fi

          # Example filename:
          # odin4-linux-x86_64-3.4.0-d278538-rc1.zip OR without suffix
          BASE="$(basename "$SAMPLE")"
          # Extract "<version><suffix>" part after last '-' from "odin4-linux-<arch>-<ver><suffix>.zip"
          # We'll just strip the prefix up to the second dash and arch dash:
          # odin4-linux-ARCH-VERSUFFIX.zip -> VERSUFFIX
          VERSUFFIX="$(echo "$BASE" | sed -E 's/^odin4-linux-[^-]+-([^.]+)\.zip$/\1/' || true)"
          if [ -z "$VERSUFFIX" ] || [ "$VERSUFFIX" = "$BASE" ]; then
            # fallback: keep generic name
            OUT="odin4-linux-all.zip"
          else
            OUT="odin4-linux-all-${VERSUFFIX}.zip"
          fi

          (cd bundle && zip "../${OUT}" ./*.zip)

          echo "OUT=${OUT}" >> "$GITHUB_ENV"

      - name: Upload bundle artifact
        uses: actions/upload-artifact@v4
        with:
          name: odin4-linux-all
          path: ${{ env.OUT }}